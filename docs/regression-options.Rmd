---
title: "log-regression-attempt"
author: "Cole Brookson"
date: '2022-08-09'
output: html_document
---

```{r}
library(tidyverse)
library(here)

raw_df = read.csv(here("./data/wild-lice-data/clean/scfs-data-clean.csv"))
```

We care about only a handful of columns - those that distinguish all of the motiles, all of the copepodites, and the proportions of leps for both of those. 
```{r}
raw_lice_df = raw_df[, c("year", "prop_lep_mot", "prop_lep_cope", "all_mot", 
                    "all_cope", "unid_cope", "unid_adult", "all_chal",
                    "lep_cope", "cal_cope", "lep_mot")]

# also remove all of 2001
df = raw_lice_df[which(raw_lice_df$year != 2001),]
df_2001 = raw_lice_df[which(raw_lice_df$year == 2001),]
df_2005_onward = raw_lice_df[which(raw_lice_df$year >= 2005),]
df_2002_2004 = raw_lice_df[which(raw_lice_df$year %in% c(2002, 2003, 2004)),]
```

We can look at how the proportions lie out against the raw data: 
```{r}
plot(x = jitter(df$all_mot, 5), y = jitter(df$prop_lep_mot, 5), 
     col = "black", 
     bg = "red",
     pch = 21, 
     cex = 0.7, 
     xlab = "Number of All Motiles",
     ylab = "Proportion of L. salmonis")
```
```{r}
plot(x = jitter(df_2005_onward$all_cope, 5), y = jitter(df_2005_onward$prop_lep_cope, 5), 
     col = "black", 
     bg = "blue",
     pch = 21, 
     cex = 0.7, 
     xlab = "Number of All Copepodites",
     ylab = "Proportion of L. salmonis")
```

Here are the values of just the proportions in a histogram: 

```{r}
hist(df_2005_onward$prop_lep_cope,
     xlab = "Proportion of Copepodids that are L. salmonis (years 2005 - 2021)",
     main = "")
```

```{r}
hist(df$prop_lep_mot,
     xlab = "Proportion of Motiles that are L. salmonis",
     main = "")
```



To fit our logistic regression, we simply pass our proportion as the response variable. **Note importantly here, this is a regression with the proportion against all motiles, NOT all lice, just all motiles, as described in the scenarios document.**

```{r}
# motile regression
mot_reg = glm(prop_lep_mot ~ all_mot, 
              # binomial family 
              family = binomial(link = "logit"),
              data = df)
# cope regression 
cope_reg = glm(prop_lep_cope ~ all_cope,
               # binomial family
               family = binomial(link = "logit"),
               data = df_2005_onward)

# look at the output of both:
summary(mot_reg)
summary(cope_reg)
```

Get predicted values:

```{r}
# find max of both raw values:
max_mot = max(raw_lice_df$all_mot)
max_cope = max(raw_lice_df$all_cope)

# make sequence of values to predict on
mot_seq = data.frame(all_mot = seq(0, max_mot, 0.01))
cope_seq = data.frame(all_cope = seq(0, max_cope, 0.01))

# make prediction for mots
pred_mot = data.frame(
  all_mots = mot_seq$all_mot,
  pred_prop = stats::predict(
    mot_reg, 
    mot_seq,
    type = "response",
    se.fit = TRUE)
)

# make prediction for copes
pred_copes = data.frame(
  all_copes = cope_seq$all_cope,
  # predicted column
  pred_prop = stats::predict(
    cope_reg,
    cope_seq,
    type = "response", 
    se.fit = TRUE)
)

# add in 95% CI's
pred_mot$pred_prop = pred_mot$pred_prop.fit
pred_mot$lower = pred_mot$pred_prop.fit - 1.96*pred_mot$pred_prop.se.fit
pred_mot$upper = pred_mot$pred_prop.fit + 1.96*pred_mot$pred_prop.se.fit

pred_copes$pred_prop = pred_copes$pred_prop.fit
pred_copes$lower = pred_copes$pred_prop.fit - 1.96*pred_copes$pred_prop.se.fit
pred_copes$upper = pred_copes$pred_prop.fit + 1.96*pred_copes$pred_prop.se.fit
```

Now make prediction plots: 

## Prediction Plot for Mots
```{r}
library(ggplot2)

ggplot() + 
  geom_point(data = df, aes(x = all_mot, y = prop_lep_mot), 
             shape = 21,
             colour = "black",
             fill = "red2",
             alpha = 0.1,
             position = position_jitter()) +
    geom_ribbon(data = pred_mot, aes(x = all_mots, ymin = lower, ymax = upper),
              fill = "grey80") +
  geom_line(data = pred_mot, aes(x = all_mots, y = pred_prop)) + 
  theme_bw() + 
  #geom_vline(aes(xintercept = 2.175373), colour = "blue") +
  labs(x = "Number of All Motiles", y = "Proportion of L. salmonis") +
  scale_size_manual(values = c(3, 1))
```
The plot above is for motiles, the black line is the regression prediction line. 

## Prediction Plot for Copes

```{r}
ggplot() + 
  geom_point(data = df_2005_onward, aes(x = all_cope, y = prop_lep_cope), 
             shape = 21,
             colour = "black",
             fill = "blue",
             alpha = 0.3,
             position = position_jitter()) +
      geom_ribbon(data = pred_copes, aes(x = all_copes, ymin = lower, ymax = upper),
              fill = "grey80") +
  geom_line(data = pred_copes, aes(x = all_copes, y = pred_prop)) + 
  theme_bw() + 
  #geom_vline(aes(xintercept = 2.175373), colour = "blue") +
  labs(x = "Number of All Copepodites", y = "Proportion of L. salmonis") +
  scale_size_manual(values = c(3, 1))
```


**NOTE:** There are two options from this point - since the regression is on the scale of the number of lice on single fish, not regarding year, I can simply take the projection of the model, apply the model prediction to each data point in the years we are extrapolating to and then average those predictions. 

```{r}
# make projection for each of the new values in the new years

## motile model prediction:
# make prediction for mots
mot_2001_pred = cbind(
  df_2001,
  pred_prop = stats::predict(
    mot_reg, 
    data.frame(all_mot = df_2001$all_mot),
    type = "response")
)

## copes model prediction:
cope_2002_2004_pred = data.frame(
  df_2002_2004,
  # predicted column
  pred_prop = stats::predict(
    cope_reg,
    data.frame(all_cope = df_2002_2004$all_cope),
    type = "response")
)

```

The values that we want are the proportion of the `unid_adult` and `unid_cope` that are leps: 
```{r}
mot_2001_pred$unid_adult_lep = mot_2001_pred$unid_adult * mot_2001_pred$pred_prop
cope_2002_2004_pred$unid_cope_lep = cope_2002_2004_pred$unid_cope * cope_2002_2004_pred$pred_prop
```








Let's plot those predicted points on top of the existing plots: 

```{r}
ggplot() + 
  geom_point(data = df, aes(x = all_mot, y = prop_lep_mot), 
             shape = 21,
             colour = "black",
             fill = "red2",
             alpha = 0.1,
             position = position_jitter()) +
    geom_ribbon(data = pred_mot, aes(x = all_mots, ymin = lower, ymax = upper),
              fill = "grey80") +
  geom_line(data = pred_mot, aes(x = all_mots, y = pred_prop)) + 
  geom_point()
  # geom_point(data = pred_mot_2001, aes(x = all_mot, y = pred_prop),
  #            shape = 21,
  #            colour = "black",
  #            fill = "purple",
  #            size = 2,
  #            position = position_jitter()) +
  theme_bw() + 
  geom_vline(aes(xintercept = 2.175373), colour = "blue") +
  labs(x = "Number of All Motiles", y = "Proportion of L. salmonis") +
  scale_size_manual(values = c(3, 1))
```


